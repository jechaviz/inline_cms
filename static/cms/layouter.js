function InlineCMSLayoutEditor(a){this.options=a;this.pageFrame;this.selection={element:false,path:false};this.cursor={};this.regions={};this.menus={};this.deletions=[];this.styles={};this.blockTags=["ARTICLE","ASIDE","DIV","FIELDSET","FIGURE","FOOTER","H1","H2","H3","H4","H5","H6","HEADER","HGROUP","UL","LI","OUTPUT","P","PRE","PROGRESS","SECTION","SPAN"];this.createPathGenerator=function(){$.fn.getPath=function(){if(this.length!=1){return false}var f,e=this;while(e.length){var d=e[0],b=d.localName;if(!b){break}b=b.toLowerCase();if(d.id){return b+"#"+d.id+(f?">"+f:"")}else{if(d.className){b+="."+d.className.split(/\s+/)[0]}}var c=e.parent(),g=c.children(b.replace(/(:|\[|\]|,|\(|\))/g,"\\$1"));if(g.length>1){b+=":eq("+c.children().index(e)+")"}f=b+(f?">"+f:"");e=c}return f}};this.restorePanelState=function(){var b={};if(!localStorage.getItem("inlinecms-layouter-panel")){b={position:{left:50,top:150},tab:"#tab-elements",expanded:true}}else{b=JSON.parse(localStorage.getItem("inlinecms-layouter-panel"))}this.panel.css(b.position);if(!b.expanded){$(".body",this.panel).hide();$(".title .tb-collapse i",this.panel).toggleClass("fa-caret-up").toggleClass("fa-caret-down")}};this.savePanelState=function(){localStorage.setItem("inlinecms-layouter-panel",JSON.stringify({position:this.panel.position(),expanded:$(".body:visible",this.panel).length}))};this.done=function(){var b=this.options.layouterUrl+"?"+$.param({done:1});if(!this.hasChanges()){window.location.href=b;return}this.showConfirmationDialog(this.lang("layoutSaveConfirm"),function(){cms.save(function(){window.location.href=b})},function(){window.location.href=b})};this.save=function(e){var b=$("#layout-selector",this.panel);var c=$("#b-save-layout",this.panel);b.prop("disabled",true);c.prop("disabled",true).find("i").removeClass("fa-check").addClass("fa-spinner").addClass("fa-spin");var d=0;if("$" in this.getFrameWindow()){if("fn" in this.getFrameWindow().$){if("jquery" in this.getFrameWindow().$.fn){d=this.getFrameWindow().$.fn.jquery}}}this.runModule("layouter","saveLayout",{layout:this.options.layout,regions:JSON.stringify(this.regions),menus:JSON.stringify(this.menus),deletions:JSON.stringify(this.deletions),styles:JSON.stringify(this.styles),jquery:d},function(g){b.prop("disabled",false);c.prop("disabled",false).find("i").removeClass("fa-spinner").addClass("fa-check").removeClass("fa-spin");cms.noChanges();if(typeof(e)==="function"){e(g);return}if(!cms.options.isWizard){return}var i=$("option:selected",b).index();var h=$("option",b).length;if(i<h-1){var f=$("option",b).eq(i+1).val();cms.goToLayout(f,true)}else{cms.done()}})};this.buildBlockToolbar=function(d,c,i,h,g){var b=$("<div/>").addClass("inline-label").addClass("inlinecms").html(i);if(c.data("global")){b.html(i+' <i class="fa fa-chain"></i>')}var f=$("<div/>").addClass("inline-toolbar").addClass("inlinecms");var e={options:{icon:"fa-pencil",title:this.lang("settings"),click:function(j){h(j)}},style:{icon:"fa-expand",title:this.lang("sizes"),click:function(k,j){cms.cancelSelection();cms.editSelectionStyle(j)}},"delete":{icon:"fa-trash",title:this.lang("delete"),click:function(j){g(j)}}};if(d==="menu"){delete e.style}$.map(e,function(j,l){var k=$("<div></div>").addClass("button").addClass("b-"+l);k.attr("title",j.title);k.html('<i class="fa '+j.icon+'"></i>');f.append(k);if(typeof(j.click)==="function"){k.click(function(){var m=$(this).parents(".inlinecms-"+d).eq(0);var n=m.data(d);j.click(n,m)})}return j});$(".inline-label",c).remove();$(".inline-toolbar",c).remove();c.append(b);c.append(f)};this.buildRegionToolbar=function(c){var b=$('[data-region="'+c+'"]',this.pageFrame);this.buildBlockToolbar("region",b,c,function(){cms.editRegion(c)},function(d){cms.deleteRegion(c)})};this.buildMenuToolbar=function(c){var b=$('*[data-menu="'+c+'"]',this.pageFrame);this.buildBlockToolbar("menu",b,c,function(){cms.editMenu(c)},function(d){cms.deleteMenu(c)})};this.getElementStyle=function(b){if(!b){b=this.selection.element}var e=["width","height","paddingTop","paddingBottom","paddingLeft","paddingRight","marginTop","marginBottom","marginLeft","marginRight"];var c={};var d=b.get(0);$.each(e,function(f,g){c[g]=d.style[g].replace("px","")});return c};this.editSelectionStyle=function(b){if(!b){b=this.selection.element}var c=this.getElementStyle(b);this.openForm({id:"style-edit",title:this.lang("styleSettings"),values:c,source:{module:"layouter",action:"loadStyleForm"},buttons:{ok:cms.lang("save")},onShow:function(d){$.each(c,function(f,g){var e=$("input[name="+f+"]",d);e.attr("placeholder",b.css(f))})},onSubmit:function(e){$.each(e,function(g,h){if(h){if($.isNumeric(h)){h=Number(h)}b.css(g,h)}else{b.css(g,"")}});if(b==cms.selection.element){cms.selectElement(b)}var d=b.attr("style");var f=b.getPath();if(d){cms.styles[f]=d}if(!d&&cms.styles[f]){delete cms.styles[f]}cms.setChanges()}})};this.addMenu=function(){if(!this.isMenuSelected()){return}this.selectMenu();this.openForm({id:"menu-add",title:cms.lang("menuCreate"),values:{},source:{module:"layouter",action:"loadMenuForm",data:{mode:"add"}},buttons:{ok:cms.lang("create")},onCreate:function(d){var e=$(".f-menu-id",d);var b=$("select",e);var c=$("input",e);$("button",e).click(function(f){f.preventDefault();b.toggle();c.toggle();$("i",e).toggleClass("fa-navicon").toggleClass("fa-pencil");if(c.is(":visible")){c.val("").focus()}else{c.val(b.val())}});b.change(function(){c.val($(this).val())})},onShow:function(d){var e=$(".f-menu-id",d);var b=$("select",e);var c=$("input",e);if($("option",b).length>0){c.hide().val(b.val());b.show()}$("i",e).removeClass("fa-navicon").addClass("fa-pencil");$(".f-path input",d).val(cms.selection.path);$(".f-items select",d).html("");cms.selection.element.children().each(function(){var h=$(this);var g=h.prop("tagName")==="A"?h:h.children("a").eq(0);var f=$("<option/>").val(h.index()).html(g.html());$(".f-items select",d).append(f)})},onValidate:function(b,c){if(typeof(cms.menus[b.id])!=="undefined"){c({success:false,error:cms.lang("menuIdUniqError")});return}cms.runModule("layouter","validateMenu",b,function(d){c(d)})},onSubmit:function(c,d){cms.selection.element.addClass("inlinecms-menu");cms.selection.element.attr("data-menu",c.id);var e={id:c.id,active_item_index:c.active_item_index,path:cms.selection.path};var b=$(".f-menu-id select",d);if($('option[value="'+e.id+'"]',b).length==0){$("<option/>").attr("value",e.id).html(e.id).prependTo(b)}cms.menus[e.id]=e;cms.buildMenuToolbar(e.id);cms.cancelSelection();cms.setChanges()},onCancel:function(b){cms.cancelSelection()}})};this.editMenu=function(d){var c=this.menus[d];if(!c){return}var b=$('*[data-menu="'+c.id+'"]',this.pageFrame);this.openForm({id:"menu-edit",title:cms.lang("menuSettings"),values:c,source:{module:"layouter",action:"loadMenuForm",data:{mode:"edit"}},buttons:{ok:cms.lang("save")},onCreate:function(g){var h=$(".f-menu-id",g);var e=$("select",h);var f=$("input",h);$("button",h).click(function(i){i.preventDefault();e.toggle();f.toggle();$("i",h).toggleClass("fa-navicon").toggleClass("fa-pencil");if(f.is(":visible")){f.focus()}else{e.val(f.val())}});e.change(function(){$(".f-menu-id input",g).val($(this).val())})},onBeforeShow:function(e){$(".f-items select",e).html("");b.children().not(".inlinecms").each(function(){var h=$(this);var g=h.prop("tagName")==="A"?h:h.children("a").eq(0);var f=$("<option/>").val(h.index()).html(g.html());$(".f-items select",e).append(f)})},onShow:function(f,e){$(".f-menu-id select",f).val(e.id)},onValidate:function(e,f){if(c.id!=e.id){if(typeof(cms.menus[e.id])!=="undefined"){f({success:false,error:cms.lang("menuIdUniqError")});return}}cms.runModule("layouter","validateMenu",e,function(g){f(g)})},onSubmit:function(e){b.attr("data-menu",e.id);$(".inlinecms.inline-label",b).html(e.id);if(e.id!=c.id){delete cms.menus[c.id]}cms.menus[e.id]={id:e.id,active_item_index:e.active_item_index,path:c.path};cms.buildMenuToolbar(e.id);cms.setChanges()}})};this.deleteMenu=function(d){var c=this.menus[d];if(!c){return}var b=$('*[data-menu="'+d+'"]',this.pageFrame);this.showConfirmationDialog(this.lang("menuDeleteConfirm",{menu:c.id}),function(){b.removeAttr("data-menu");b.removeClass("inlinecms-menu");$(".inlinecms",b).remove();delete cms.menus[d];cms.setChanges()})};this.addRegion=function(){this.openForm({id:"region-add",title:cms.lang("regionCreate"),values:{id:this.selection.element.attr("id")},source:{module:"layouter",action:"loadRegionForm",data:{mode:"add"}},buttons:{ok:cms.lang("create")},onShow:function(b){$(".f-path input",b).val(cms.selection.path)},onValidate:function(b,c){if(typeof(cms.regions[b.id])!=="undefined"){c({success:false,error:cms.lang("regionIdUniqError")});return}cms.runModule("layouter","validateRegion",b,function(d){c(d)})},onSubmit:function(b){var c={id:b.id,path:cms.selection.path,is_fixed:(b.type==="fixed"),is_collection:(b.type==="collection"),is_global:(b.global==="yes"),is_scan:b.is_scan,type:b.type,global:b.global};cms.selection.element.addClass("inlinecms-region");cms.selection.element.attr("data-region",b.id);if(c.is_fixed){cms.selection.element.addClass("inlinecms-region-fixed");cms.selection.element.attr("data-fixed","yes")}if(c.is_global){cms.selection.element.attr("data-global","yes")}if(c.is_collection){cms.selection.element.addClass("inlinecms-region-collection")}cms.regions[c.id]=c;cms.buildRegionToolbar(c.id);cms.cancelSelection();cms.setChanges()}})};this.editRegion=function(d){var c=this.regions[d];if(!c){return}var b=$('*[data-region="'+c.id+'"]',this.pageFrame);this.openForm({id:"region-edit",title:cms.lang("regionSettings"),values:c,source:{module:"layouter",action:"loadRegionForm",data:{mode:"edit"}},buttons:{ok:cms.lang("save")},onValidate:function(e,f){if(e.id!=c.id){if(typeof(cms.regions[e.id])!=="undefined"){f({success:false,error:cms.lang("regionIdUniqError")});return}}cms.runModule("layouter","validateRegion",e,function(g){f(g)})},onSubmit:function(f){var e=(f.type==="fixed");var h=(f.type==="collection");var g=(f.global==="yes");cms.regions[f.id]={id:f.id,path:c.path,is_fixed:e,is_collection:h,is_global:g,is_scan:f.is_scan,type:f.type,global:f.global};b.attr("data-region",f.id);if(e){b.data("fixed",true).addClass("inlinecms-region-fixed")}else{b.removeAttr("data-fixed").removeClass("inlinecms-region-fixed")}if(h){b.data("collection",true).addClass("inlinecms-region-collection")}else{b.removeAttr("data-collection").removeClass("inlinecms-region-collection")}if(g){b.data("global",true)}else{b.removeAttr("data-global").data("global",false)}if(f.id!=c.id){delete cms.regions[c.id]}cms.buildRegionToolbar(f.id);cms.setChanges()}})};this.deleteRegion=function(d){var c=this.regions[d];if(!c){return}var b=$('*[data-region="'+d+'"]',this.pageFrame);this.showConfirmationDialog(this.lang("regionDeleteConfirm",{region:c.id}),function(){b.removeAttr("data-region").removeAttr("data-fixed").removeAttr("data-global");b.removeClass("inlinecms-region").removeClass("inlinecms-region-fixed").removeClass("inlinecms-region-collection");$(".inlinecms",b).remove();delete cms.regions[d];cms.setChanges()})};this.selectElement=function(e,b,d){if(!this.isLegitSelection(e)){return}if(typeof(d)==="undefined"){d=true}var c=e.prop("tagName");var f=e.parent();if(this.blockTags.indexOf(c)<0&&c!=="A"&&d){if(f.prop("tagName")=="BODY"){return}this.selectElement(f);return}if(c=="A"){if(!this.isMenuSelected(e)){this.selectElement(f);return}b="picker-menu"}this.selection={element:e,path:e.getPath()};this.cursor.attr("class","inlinecms picker-cursor");if(typeof(b)==="string"){this.cursor.addClass(b)}this.cursor.css({width:e.outerWidth(),height:e.outerHeight(),left:e.offset().left,top:e.offset().top}).show();$("#b-zoom-out",this.panel).prop("disabled",false);$("#b-zoom-in",this.panel).prop("disabled",false);$("#b-cancel",this.panel).prop("disabled",false);$(".path-hint",this.cursor).removeClass("bottom").html(this.selection.path);if($(".path-hint",this.cursor).offset().top<5){$(".path-hint",this.cursor).addClass("bottom")}this.toggleButtons()};this.selectMenu=function(b){this.selectElement(b,"picker-menu")};this.onViewportResize=function(){if(!this.selection.element){return}this.selectElement(this.selection.element)};this.onDomClick=function(b){this.selectElement(b)};this.selectMenu=function(){var b=this.selection.element;if(b.parent().prop("tagName")==="LI"){this.selectElement(b.parents("ul").eq(0),"picker-menu",false)}if(b.siblings("a").length>=1){this.selectElement(b.parent(),"picker-menu",false)}};this.isMenuSelected=function(b){if(typeof(b)=="undefined"){b=this.selection.element}if(!b){return false}if(b.prop("tagName")!=="A"){return false}if(b.parent().prop("tagName")==="LI"){return true}if(b.siblings("a").length>=1){return true}return false};this.isLegitSelection=function(b){var c=true;if(b.is(".inlinecms")){c=false}if(b.is(".inlinecms-region")){c=false}if(b.is(".inlinecms-menu")){c=false}if(b.parents(".inlinecms").length>0){c=false}if(b.parents(".inlinecms-region").length>0){c=false}if(b.find(".inlinecms-region").length>0){c=false}if(b.parents(".inlinecms-menu").length>0){c=false}if(b.find(".inlinecms-menu").length>0){c=false}return c};this.cancelSelection=function(){$(".pane-menu",this.panel).show();$(".pane-selection",this.panel).hide();this.selection.element=false;this.selection.path=false;this.cursor.hide();this.toggleButtons()};this.deleteSelection=function(){this.showConfirmationDialog(this.lang("deleteSelectionConfirm"),function(){var b=cms.selection.element;cms.deletions.push({path:b.getPath()});cms.cancelSelection();b.remove();cms.setChanges()})};this.goToLayout=function(d,c){var e={layout:d};if(typeof(c)!=="undefined"){e.wizard=1}var b=this.options.layouterUrl+"?"+$.param(e);if(!this.hasChanges()){window.location.href=b;return}this.showConfirmationDialog(this.lang("layoutSaveConfirm"),function(){cms.save(function(){window.location.href=b})},function(){window.location.href=b})};this.updateLayout=function(){cms.showLoadingIndicator();this.runModule("layouter","updateLayout",{layout:this.options.layout,regions:JSON.stringify(this.regions),menus:JSON.stringify(this.menus),deletions:JSON.stringify(this.deletions),styles:JSON.stringify(this.styles),jquery:typeof(this.getFrameWindow().$.fn.jquery)==="string"?this.getFrameWindow().$.fn.jquery:0},function(b){cms.goToLayout(cms.options.layout);cms.hideLoadingIndicator()})};this.zoomOut=function(){if(!this.selection.element){return}if(!this.selection.element.parent().length){return}this.selectElement(this.selection.element.parent().eq(0))};this.zoomIn=function(){if(!this.selection.element){return}var b;if(this.selection.element.children().length){b=this.selection.element.children().eq(0)}else{if(this.selection.element.siblings().length){b=this.selection.element.siblings().eq(0)}else{return}}this.selectElement(b)};this.toggleButtons=function(){this.contextMenu.hide();var c=this.selection.element!==false;var b=c&&this.selection.element.css("display")!="inline";var d=this.isMenuSelected();$(".i-add-region",this.contextMenu).toggleClass("disabled",!b);$(".i-add-menu",this.contextMenu).toggleClass("disabled",!d);$(".i-zoom-out",this.contextMenu).toggleClass("disabled",!c);$(".i-zoom-in",this.contextMenu).toggleClass("disabled",!c);$(".i-delete",this.contextMenu).toggleClass("disabled",!c);$(".i-cancel",this.contextMenu).toggleClass("disabled",!c)};this.bindControls=function(){$("body",this.pageFrame).on("keyup",function(b){if(b.which===27){cms.cancelSelection();cms.contextMenu.hide()}});$("li i",this.contextMenu).on("click",function(b){$(this).parent("li").click()});$("li",this.contextMenu).on("click",function(b){console.log("click");if($(this).is(".disabled")){b.stopImmediatePropagation();return false}});$(".i-add-region",this.contextMenu).on("click",function(){cms.addRegion();cms.contextMenu.hide()});$(".i-add-menu",this.contextMenu).on("click",function(){cms.addMenu();cms.contextMenu.hide()});$(".i-zoom-out",this.contextMenu).on("click",function(){cms.zoomOut();cms.contextMenu.hide()});$(".i-zoom-in",this.contextMenu).on("click",function(){cms.zoomIn();cms.contextMenu.hide()});$(".i-style",this.contextMenu).on("click",function(){cms.editSelectionStyle();cms.contextMenu.hide()});$(".i-delete",this.contextMenu).on("click",function(){cms.deleteSelection();cms.contextMenu.hide()});$(".i-cancel",this.contextMenu).on("click",function(){cms.cancelSelection();cms.contextMenu.hide()});$("#b-save-layout",this.panel).on("click",function(){cms.save()});$("#b-done",this.panel).on("click",function(){cms.done()});$("#layout-selector",this.panel).on("change",function(){var b=$(this).val();cms.goToLayout(b)});$("#update-layout",this.panel).on("click",function(){cms.showConfirmationDialog(cms.lang("layoutUpdateConfirm",{layout:cms.options.layout}),function(){cms.updateLayout()})})};this.offSelfEvents=function(){$(".inlinecms *").off("click").off("mouseenter").off("mouseleave");$(".inlinecms").off("click").off("mouseenter").off("mouseleave")};this.initStructure=function(){$("*[data-region]",this.pageFrame).each(function(){var b=$(this);var c={id:b.data("region"),path:b.getPath(),is_fixed:b.attr("data-fixed")!==undefined,is_global:b.attr("data-global")!==undefined,is_collection:b.attr("data-collection")!==undefined,type:"content",global:"no"};if(c.is_fixed){c.type="fixed"}if(c.is_collection){c.type="collection"}if(c.is_global){c.global="yes"}cms.regions[c.id]=c;b.addClass("inlinecms-region");if(c.is_fixed){b.addClass("inlinecms-region-fixed")}if(c.is_collection){b.addClass("inlinecms-region-collection")}cms.buildRegionToolbar(c.id)});$("*[data-menu]",this.pageFrame).each(function(){var d=$(this);var c=0;for(var b=0;b<d.children().length;b++){var f=d.children().eq(b);if(f.attr("data-selected")!==undefined){c=b;break}}var e={id:d.data("menu"),active_item_index:c,path:d.getPath()};cms.menus[e.id]=e;d.addClass("inlinecms-menu");cms.buildMenuToolbar(e.id)})};this.initUI=function(){$("body *",this.pageFrame).off("click");this.cursor=$("<div/>").addClass("inlinecms").addClass("picker-cursor").hide();this.cursor.append($("<div/>").addClass("path-hint").addClass("inlinecms"));$("body",this.pageFrame).append(this.cursor);this.contextMenu=$("#inlinecms-context-menu",this.pageFrame);$("body *",this.pageFrame).on("click",function(b){if(b.ctrlKey){return}b.preventDefault();b.stopPropagation();cms.onDomClick($(b.target));cms.contextMenu.hide()}).on("selectstart",function(){return false});this.offSelfEvents();this.cursor.on("contextmenu",function(e){var f=10;var c=$("body").width();var d=$("body").height();var b=e.pageX;var g=e.pageY;if(b+cms.contextMenu.width()>c-f){b=b-cms.contextMenu.width()-10}if(g+cms.contextMenu.height()>d-f){g=g-cms.contextMenu.height()-10}cms.contextMenu.css({left:b,top:g}).show().mousemove();return false});this.cursor.on("mouseup",function(b){b.preventDefault();b.stopPropagation();if(b.which===1){cms.contextMenu.hide();cms.zoomOut()}return false});this.buildPanel();this.restorePanelState();this.bindControls();this.panel.show();$(window).on("resize",function(){cms.onViewportResize()})};$(function(){cmsAddCore(cms);cms.showLoadingIndicator();cms.createPathGenerator();cms.loadLang(["shared","client"],function(){$("#page-frame").attr("src",cms.options.editorUrl).load(function(){cms.pageFrame=$("#page-frame").contents();cms.initUI();cms.initStructure();cms.hideLoadingIndicator()})})})};